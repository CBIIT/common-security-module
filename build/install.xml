<?xml version="1.0" encoding="utf-8" ?>
<!--
$Id: install.xml 4757 2008-05-15 20:43:31Z zengje $
$HeadURL: http://gforge.nci.nih.gov/svnroot/upt/trunk/software/install.xml $
-->
<project name="csm-upt-installer" default="upgrade" basedir="." 
	xmlns:ivy="antlib:org.apache.ivy.ant"
	>
	<description>
		TBD
	</description>

	<!-- Properties file related properties and tasks -->
	<property environment="env" />
	<property file="project.properties"/>
	<property name="properties.file" value="${basedir}/upgrade.properties"/>
	<property name="properties.install.file" value="${basedir}/install.properties"/>
	<replaceregexp file="${properties.file}" byline="true" match="^([\w\d.]+)=(.*[\w\d\/\{\}\\]+)[ \t]+\r*$" replace="\1=\2"/>
	<replaceregexp file="${properties.file}" byline="true" match="^([\w\d.]+)=[ \t]+(.*[\w\d\/\{\}\\]+)\r*$" replace="\1=\2"/>
	<replaceregexp file="${properties.install.file}" byline="true" match="^([\w\d.]+)=(.*[\w\d\/\{\}\\]+)[ \t]+\r*$" replace="\1=\2"/>
	<replaceregexp file="${properties.install.file}" byline="true" match="^([\w\d.]+)=[ \t]+(.*[\w\d\/\{\}\\]+)\r*$" replace="\1=\2"/>
	<property file="${properties.file}" />
	<property file="${properties.install.file}" />


	<!-- Generic properties -->
	<property name="lib.dir" value="${basedir}/lib" />
	<property name="working.dir" value="${basedir}/working" />
	<property name="log.dir" value="${basedir}/logs" />
	<property name="bda-utils.dir" value="${basedir}/bda-utils"/>

	<!-- Install Time properties -->
	<!-- Source and target directories -->
	<property name="bda-utils.dir.src" value="${bda-utils.dir}" />
	<property name="tools.dir.src" value="${basedir}/${tools.dist.relative.dir}" />
	<property name="common.dir.src" value="${basedir}/${common.dist.relative.dir}" />
	<property name="common.dir.target" value="${working.dir}/${common.dist.relative.dir}" />
	<property name="db-install.dir.dest" value="${working.dir}/${db-install.dist.relative.dir}" />
	<property name="db-upgrade.dir.dest" value="${working.dir}/${db-upgrade.dist.relative.dir}" />
	<property name="jboss-conf.dir.target" value="${working.dir}/${jboss-conf.dist.relative.dir}" />
	<property name="tomcat-conf.dir.target" value="${working.dir}/${tomcat-conf.dist.relative.dir}" />

	<!-- *-ds.xml and WAR -->
	<property name="upt.dir.dist" value="${basedir}/${upt.dist.relative.dir}" />
	<property name="upt.ds.file" value="upt-ds.xml" />
	<property name="upt.ds.tomcat.file" value="upt.xml" />
	<property name="upt.app-sec-conf.file" value="ApplicationSecurityConfig.xml" />
	<property name="upt.hibernate.file" value="hibernate.cfg.xml" />
	<property name="upt.war.file" value="upt.war" />
	<property name="securityws.dir.dist" value="${basedir}/${securityws.dist.relative.dir}" />
	<property name="securityws.war.file" value="securityws.war" />
	<property name="clm.jar.file" value="clm-4.0.jar" />

	<!-- Paths -->
	<path id="bda-utils.classpath">
		<fileset dir="${bda-utils.dir}">
			<include name="**/*.jar" />
		</fileset>
	</path>
	<!-- Task definitions -->
	<taskdef uri="antlib:org.apache.ant.antunit" resource="org/apache/ant/antunit/antlib.xml">
		<classpath>
			<pathelement location="${bda-utils.dir}/antunit-1.0.jar" />
		</classpath>
	</taskdef>
	<taskdef name="xmlconfig" classname="com.xmlconfig.anttask.XmlConfig" classpathref="bda-utils.classpath" />
	<taskdef name="for" classname="net.sf.antcontrib.logic.ForTask">
		<classpath>
			<pathelement location="${bda-utils.dir}/ant-contrib-1.0b3.jar"/>
		</classpath>
	</taskdef>
	<taskdef resource="net/sf/antcontrib/antcontrib.properties">
		<classpath>
			<pathelement location="${bda-utils.dir}/ant-contrib-1.0b3.jar"/>
			<pathelement location="${bda-utils.dir}/bcel-5.1.jar"/>
			<pathelement location="${bda-utils.dir}/commons-httpclient-3.0.1.jar"/>
			<pathelement location="${bda-utils.dir}/commons-logging-1.0.4.jar"/>
			<pathelement location="${bda-utils.dir}/ivy-1.3.1.jar"/>
		</classpath>
	</taskdef>

	<!-- Conditionals -->
	<available file="${jboss.home}/server/${jboss.server.name}/conf/jboss-service.xml" property="jboss.exists"/>
	<!-- upt can use either Oracle or MySQL as its database platform, this is controled by the database.type property.  Based on the value of this property sent several variables for use during install -->
	<switch value="${database.type}">
		<case value="oracle">
			<property name="database.dialect" value="org.hibernate.dialect.OracleDialect"/>
			<property name="is.oracle" value="true"/>
			<property name="database.driver.file" value="${bda-utils.dir}/ojdbc14-10.2.0.3.0.jar"/>
			<property name="database.driver" value="oracle.jdbc.driver.OracleDriver"/>
			<property name="db-incr.list.file" value="${db-incr.oracle.list.file}"/>
			<property name="db-incr.conf.file" value="${db-incr.oracle.conf.file}"/>
		</case>
		<case value="mysql">
			<property name="database.dialect" value="org.hibernate.dialect.MySQLDialect"/>
			<property name="is.mysql" value="true"/>
			<property name="database.driver.file" value="${bda-utils.dir}/mysql-connector-java-5.0.5.jar"/>
			<property name="database.driver" value="com.mysql.jdbc.Driver"/>
			<property name="db-incr.list.file" value="${db-incr.mysql.list.file}"/>
			<property name="db-incr.conf.file" value="${db-incr.mysql.conf.file}"/>
		</case>
		<case value="postgresql">
			<property name="database.dialect" value="org.hibernate.dialect.PostgreSQLDialect"/>
			<property name="is.postgresql" value="true"/>
			<property name="database.driver.file" value="${bda-utils.dir}/postgresql-jdbc3-8.3-603.jar"/>
			<property name="database.driver" value="org.postgresql.Driver"/>
			<property name="db-incr.list.file" value="${db-incr.postgresql.list.file}"/>
			<property name="db-incr.conf.file" value="${db-incr.postgresql.conf.file}"/>
		</case>
		<default>
			<fail message="Invalid database type ${database.type}"/>
		</default>
	</switch>

	<!-- figure out whether to use install-properties.template or upgrade-proprties.template -->
	<propertyregex property="properties.file.type"
		input="${properties.file}"
		regexp=".*(install|upgrade).*"
		select="\1"
		/>
	<echo message="Properties file type = ${properties.file.type}"/>
	<if>
		<equals arg1="${properties.file.type}" arg2="install" />
		<then>
			<property name="properties.template.file" value="install-properties.template" />
		</then>
		<elseif>
			<equals arg1="${properties.file.type}" arg2="upgrade" />
			<then>
				<property name="properties.template.file" value="upgrade-properties.template" />
			</then>
		</elseif>
	</if>
	<!-- Includes-->
	<import file="${bda-utils.dir}/bda-build-utils-${bda.version}.xml" />
	<!-- Generated and used by database incremental build process -->
	<import file="db-integrate.xml" />

	<!-- Read db configs from existing ds.xml if it exists -->
	<available file="${jboss.home}/server/${jboss.server.name}/deploy/${upt.ds.file}" property="ds.exists"/>
	<if>
		<isset property="ds.exists"/>
		<then>
			<jboss-read-dbconfig
				jboss.ds-xml.file="${upt.ds.file}"
				/>
		</then>
		<else>
			<echo message="Warning- could not find ${jboss.home}/server/${jboss.server.name}/deploy/${upt.ds.file}"/>
		</else>
	</if>

	<!-- There is any issue with copying files with a filtersfile, any properties with a value of
		another property do not get expanded (xx=${yy} @xx@ will be replaced with ${yy} not the
		value).  I have defined a filter set below for these properties, I then two two copies
		one to the resource.dir.temp using the filterset and then one to the desired directory 
		with the filter file.  If you add new properties that refer to other properties in the
		properties file please add them to the filterset-pre below.
	     Also you should include properties that are declared in this file, like database info below.
	-->
	<property name="resource.dir.temp" value="${working.dir}/tmp" />
	<filterset id="filterset.pre">
		<filter token="application.base.path" value="${application.base.path}"/>
		<filter token="application.url" value="${application.url}"/>
		<filter token="database.url" value="${database.url}"/>
		<filter token="database.clm.url" value="${database.url}"/>
		<filter token="database.system.url" value="${database.system.url}"/>
		<filter token="jboss.home" value="${jboss.home}"/>
		<!-- added internal properties that may be used in a filtered copy -->
		<filter token="database.driver" value="${database.driver}"/>
		<filter token="database.dialect" value="${database.dialect}"/>
		<filter token="hibernate.cfg.file.path" value="${hibernate.cfg.file.path}"/>
		<filter token="application.jndi" value="${application.jndi}"/>
		<filter token="application.context.name" value="${application.context.name}"/>		
	</filterset>
	
	<!-- Start logging -->
	<mkdir dir="${log.dir}" />
	<tstamp>
		<format property="install.time" pattern="yyyy-MM-dd-HH-mm" />
	</tstamp>
	<record name="${log.dir}/install-${install.time}.log" action="start"/>


	<!-- Installer section -->
	<target name="diag">
		<echoproperties/>
	</target>

	<!-- Clean up destination directory -->
	<target name="install:clean" description="Removes all files from the local filesystem">
		<sleep seconds="5" />
		<delete dir="${application.base.path}" quiet="false" />
	</target>

	<!-- Does directory management and copy some files with filtering to ensure token expansion -->
	<target name="install:init" description="Does directory management to initialize install">
		<mkdir dir="${working.dir}" />
		<delete dir="${working.dir}"/>
		<mkdir dir="${working.dir}" />
		<mkdir dir="${resource.dir.temp}"/>
		<!-- Copy files to ensure values containing variables are expanded, such properties are stored in filterset.pre -->
		<copy todir="${resource.dir.temp}" filtering="true">
			<fileset dir="${common.dir.src}">
				<include name="**/*"/>
			</fileset>
			<filterset refid="filterset.pre"/>
		</copy>
		<copy todir="${common.dir.target}" filtering="true">
			<fileset dir="${resource.dir.temp}">
				<include name="**/*"/>
			</fileset>
			<filterset>
				<filtersfile file="${properties.file}"/>
				<filtersfile file="project.properties"/>
			</filterset>
		</copy>
	</target>

	<!-- Wrapper install database target, depends on both MySQL and Oracle sub-targets, ifs should ensure only one is run.  Target path can be skipped by exlude.database also calls upgrade:database -->
	<target name="install:database:prep" description="Copies db files with filtering" unless="exclude.database" depends="install:init">
		<echoproperties prefix="database"/>
	</target>
	<target name="install:database:verify-flags">
		<if>
			<and>
				<equals arg1="${database.re-create}" arg2="true"/>
				<equals arg1="${database.drop-schema}" arg2="true"/>
			</and>
			<then>
				<fail message="You cannot set both database.re-create and database.drop-schema at the same time.  database.re-create is used in local installs.  database.drop-schema is used in remote installs.  Either one can be set for external (Cancer Center) installs."/>
			</then>
		</if>
	</target>
	<target name="install:database:re-create" description="Recreates database if database.re-create is true. Used on local installs" unless="exclude.database" depends="install:init,install:database:verify-flags">
		<if>
			<equals arg1="${database.re-create}" arg2="true"/>
			<then>
				<switch value="${database.type}">
					<case value="postgresql">
						<database-create/>
					</case>
					<case value="mysql">
						<database-create/>
					</case>
					<default>
						<echo message="Re-creation (drop and re-create) of ${database.type} databases is not supported, nothing done."/>
					</default>
				</switch>
				<property name="db.install.file.list" value="${db.install.postgresql.file.list}"/>
			</then>
			<else>
				<echo message="Database.recreate flag not set, database not re-created."/>
			</else>
		</if>
	</target>
	<target name="install:database:drop" description="Runs database drop scripts if database.drop-schema is set. Used on Tier environments (dev, qa, stg, prod)." unless="exclude.database" depends="install:init,install:database:verify-flags">
		<if>
			<equals arg1="${database.drop-schema}" arg2="true"/>
			<then>
				<switch value="${database.type}">
					<case value="postgresql">
						<property name="database.schema" value="public"/>
					</case>
					<case value="mysql">
						<property name="database.schema" value="database.name"/>
					</case>
					<case value="oracle">
						<property name="database.schema" value="database.name"/>
					</case>
				</switch>
				<echo message="Dropping database objects"/>
				<dropAllDatabaseObjects
					driver="${database.driver}"
					url="${database.url}"
					username="${database.user}"
					password="${database.password}"
					promptOnNonLocalDatabase="${prompt.user.if.not.local.database}"
					classpathref="bda-utils.classpath"
					defaultSchemaName="${database.schema}"
					/>
				<!-- Sequences don't seem to drop in first run second run cleans them up -->
				<dropAllDatabaseObjects
					driver="${database.driver}"
					url="${database.url}"
					username="${database.user}"
					password="${database.password}"
					promptOnNonLocalDatabase="${prompt.user.if.not.local.database}"
					classpathref="bda-utils.classpath"
					defaultSchemaName="${database.schema}"
					/>
				<sleep seconds="5"/>
			</then>
			<else>
				<echo message="Database.drop-schema flag not set, database schema not dropped."/>
			</else>
		</if>

	</target>

	<target name="install:database" description="Runs datbase creation scripts then calls uprade database." unless="exclude.database"
		depends="
		install:init,
		install:database:prep,
		install:database:re-create,
		install:database:drop
		">

		<switch value="${database.type}">
			<case value="oracle">
				<for list="${db.install.create.oracle.file.list}" param="db.install.oracle.file">
					<sequential>
						<run-sql-script database.url="${database.url}"
							database.user="${database.user}" 
							database.password="${database.password}" 
							sql.delimiter="/" 
							sql.delimitertype="row"
							sql.file="${db-install.dir.dest}/${database.type}/@{db.install.oracle.file}"
							onerror="continue"/>
					</sequential>
				</for>
			</case>
			<case value="mysql">
				<for list="${db.install.create.mysql.file.list}" param="db.install.mysql.file">
					<sequential>
						<echo message="${db-install.dir.dest}/${database.type}/@{db.install.mysql.file}"/>
						<run-sql-script
							database.url="${database.url}"
							database.user="${database.user}"
							database.password="${database.password}"
							sql.file="${db-install.dir.dest}/${database.type}/@{db.install.mysql.file}"
							/>
					</sequential>
				</for>
			</case>
			<case value="postgresql">
				<for list="${db.install.create.postgresql.file.list}" param="db.install.postgresql.file">
					<sequential>
						<run-sql-script
							database.url="${database.url}"
							database.user="${database.user}"
							database.password="${database.password}"
							sql.delimiter="/" 
							sql.delimitertype="row"
							sql.file="${db-install.dir.dest}/${database.type}/@{db.install.postgresql.file}"
							/>
					</sequential>
				</for>
			</case>
		</switch>
		<antcall target="upgrade:database" inheritAll="false"/>
	</target>


	<target name="install:jboss:binaries" description="Unzip JBoss binary" unless="exclude.jboss">
		<unzip dest="${application.base.path}" src="${tools.dir.src}/${jboss.binaries.file}" />
	</target>


	<target name="install:jboss:upt" description="Deploy upt upt.ear, upt-api.war and common libraries" unless="exclude.jboss">
		<!-- added to ensure working.dirs are fresh for our install -->
		<delete dir="${jboss.home}/server/${jboss.server.name}/tmp"/>
		<delete dir="${jboss.home}/server/${jboss.server.name}/work"/>

		<copy file="${upt.dir.dist}/${upt.war.file}" todir="${jboss.home}/server/${jboss.server.name}/deploy" overwrite="true" />
		<copy file="${upt.dir.dist}/${clm.jar.file}" todir="${jboss.home}/server/${jboss.server.name}/lib" overwrite="true" />
		<copy file="${database.driver.file}" todir="${jboss.home}/server/${jboss.server.name}/lib" overwrite="true" />

		<!-- Replace this with file from ivy when project is ivy'fied -->
		<copy file="${securityws.dir.dist}/${securityws.war.file}" todir="${jboss.home}/server/${jboss.server.name}/deploy" overwrite="true" />
	</target>
	
	<target name="install:tomcat:upt" description="Deploy upt upt.ear, upt-api.war and common libraries" unless="exclude.tomcat">
		<!-- added to ensure working.dirs are fresh for our install -->
		<delete dir="${tomcat.home}/temp"/>
		<delete dir="${tomcat.home}/work"/>

		<copy file="${upt.dir.dist}/${upt.war.file}" todir="${tomcat.home}/webapps" overwrite="true" />
		<copy file="${upt.dir.dist}/${clm.jar.file}" todir="${tomcat.home}/common/lib" overwrite="true" />
		<copy file="${database.driver.file}" todir="${tomcat.home}/common/lib" overwrite="true" />

		<!-- Replace this with file from ivy when project is ivy'fied -->
		<copy file="${securityws.dir.dist}/${securityws.war.file}" todir="${tomcat.home}/webapps" overwrite="true" />
	</target>

	<target name="install:tomcat:upt:configure" description="Configure upt application" unless="exclude.tomcat">
		<copy file="${tomcat-conf.dir.target}/${upt.ds.tomcat.file}" todir="${tomcat.home}/conf/Catalina/localhost" overwrite="true" />
	</target>

	<target name="install:jboss:upt:configure" description="Configure upt application" unless="exclude.jboss">
		<copy file="${jboss-conf.dir.target}/${upt.ds.file}" todir="${jboss.home}/server/${jboss.server.name}/deploy" overwrite="true" />
	</target>

	<!-- Wrapper target to configure jboss container, not deployed application -->
	<target name="install:jboss:configure" description="Configure upt" unless="exclude.jboss"
		depends="install:jboss:binaries,
		-install:jboss:configure:ports,
		-install:jboss:configure:login-conf,
		-install:jboss:configure:log4j,
		-install:jboss:configure:update-shutdown
		"/>

	<!-- Configure ports used by JBOSS (either bindings or editing jboss config.files) -->
	<target name="-install:jboss:configure:ports" description="Configure upt" unless="exclude.jboss">
		<jboss-bindings
			jboss.server.bindingfile.location="${jboss.home}/server/${jboss.server.name}/conf/bindings.xml"
			/>
	</target>

	<!-- Add custom login-config.xml content from snippet from upt/software/resources/deploy/login-config.${auth.type}-block.xml -->
	<target name="-install:jboss:configure:login-conf" unless="exclude.jboss">
		<if>
			<equals arg1="${authentication.type}" arg2="ldap"/>
			<then>
				<property name="login-config.block.file" value="${jboss-conf.dir.target}/login-config.ldap-block.xml"/>
			</then>
			<else>
				<if>
					<equals arg1="${authentication.type}" arg2="db"/>
					<then>
						<property name="login-config.block.file" value="${jboss-conf.dir.target}/login-config.db-block.xml"/>
					</then>
					<else>
						<fail message="${authentication.type} is not a valid authentiation type, please change to db or ldap and re-run the build."/>
					</else>
				</if>
			</else>
		</if>
		<echo message="Inserting ${login-config.block.file} into ${jboss.home}/server/${jboss.server.name}/conf/login-config.xml"/>
		<xmlconfig in="${jboss.home}/server/${jboss.server.name}/conf/login-config.xml" verbose="false">
			<insertbranch path="//policy" srcxmlfile="${login-config.block.file}" srcpath="//application-policy" />
		</xmlconfig>
	</target>

	<target name="-install:tomcat:configure:login-conf" unless="exclude.tomcat">
		<if>
			<equals arg1="${authentication.type}" arg2="ldap" />
			<then>
				<copyfile src="${tomcat-conf.dir.target}/login-ldap.config" dest="${tomcat.home}/conf/login.config" />
			</then>
			<else>
				<if>
					<equals arg1="${authentication.type}" arg2="db" />
					<then>
						<copyfile src="${tomcat-conf.dir.target}/login-db.config" dest="${tomcat.home}/conf/login.config" />
					</then>
					<else>
						<fail message="${authentication.type} is not a valid authentiation type, please change to db or ldap and re-run the build." />
					</else>
				</if>
			</else>
		</if>
		<echo message="Inserting ${login.config path} into ${tomcat.home}/conf/catalina.properties" />
		<propertyfile file="${tomcat.home}/conf/catalina.properties" comment="append login.config file path">
			<entry key="java.security.auth.login.config" value="${catalina.home}/conf/login.config" />			
		</propertyfile>
	</target>

	<!-- Configure log4j settings based on contents of upt/software/resrouces/deploy/log4j.block.xml -->
	<target name="-install:jboss:configure:log4j" unless="exclude.jboss">
		<!--
		<property name="log4j.block.file" value="${resource.dir.target}/log4j.block.xml"/>
		<loadfile 
			property="xml.content"
			srcFile="${log4j.block.file}"/>

		<replaceregexp file="${jboss.home}/server/default/conf/log4j.xml" byline="true"
			match="(^.*\/log4j:configuration.)"
			replace="${xml.content}${line.separator}\1"/>
		-->
	</target>

	<!-- Calls to bda macros for basic functionality -->
	<target name="install:jboss:stop" if="jboss.exists" unless="exclude.jboss">
		<jboss-stop-jboss jboss.server.jndi.port="${jboss.server.jndi.port}"/>
		<jboss-stop-jboss />
	</target>

	<target name="install:tomcat:stop" description="Stop Tomcat" unless="exclude.tomcat">
		<if>
			<available file="${tomcat.home}/bin/shutdown.sh" />
			<then>
				<tomcat-stop tomcat.home="${tomcat.home}" />
			</then>
		</if>
	</target>

	<target name="install:jboss:start" unless="exclude.jboss">
		<if>
			<not>
				<isset property="exclude.start.servers"/>
			</not>
			<then>
				<jboss-start-jboss />
			</then>
		</if>
		<sleep seconds="15"/>
	</target>
	<target name="install:validation:pre-install">		
		<validate-pre-install
			database.version="4.1.19"
			/>
	</target>

	<target name="install:validation:jboss:pre-install:ports" unless="exclude.jboss">
		<validate-ports-preinstall validation.pre.port.list="${validation.pre.port.list}" hostname="jboss.hostname">
		</validate-ports-preinstall>
	</target>

	<target name="install:validation:tomcat:pre-install:ports" unless="exclude.tomcat">
		<validate-ports-preinstall validation.pre.port.list="${validation.pre.port.list}" hostname="tomcat.hostname">
		</validate-ports-preinstall>
	</target>

	<target name="install:validation:tomcat:post-install" unless="exclude.tomcat">
		<if>
			<not>
				<isset property="exclude.start.servers"/>
			</not>
			<then>
				<validate-post-install validation.post.http.list="${validation.post.http.list}" validation.post.socket.list="${validation.post.socket.list}" jboss.home="${tomcat.home}"  jboss.server.name="${tomcat.server.name}"/>
			</then>
		</if>
	</target>

	<target name="install:validation:jboss:post-install" unless="exclude.jboss">
		<if>
			<not>
				<isset property="exclude.start.servers"/>
			</not>
			<then>
				<validate-post-install validation.post.http.list="${validation.post.http.list}" validation.post.socket.list="${validation.post.socket.list}" jboss.home="${jboss.home}"  jboss.server.name="${jboss.server.name}"/>
			</then>
		</if>
	</target>

	<target name="-install:jboss:configure:update-shutdown" unless="exclude.jboss">
		<jboss-update-shutdown />
	</target>

	<!-- Wrapper target to deploy JBOSS container -->
	<target name="install:jboss" unless="exclude.jboss"
		depends="
		install:validation:pre-install,
		install:jboss:stop,
		install:validation:jboss:pre-install:ports,
		install:clean,
		install:init,
		install:jboss:binaries,
		install:jboss:upt:re-configure,
		install:jboss:upt,
		install:jboss:upt:configure,
		install:jboss:configure,
		install:jboss:start
		" />

	<!-- Wrapper target to deploy Tomcat container -->
	<target name="install:tomcat" unless="exclude.tomcat"
		depends="
		install:validation:pre-install,
		install:tomcat:stop,
		install:validation:tomcat:pre-install:ports,
		install:clean,
		install:init,
		install:tomcat:binaries,
		install:tomcat:upt,
		install:tomcat:upt:configure,
		-install:tomcat:configure:login-conf,
		install:tomcat:configure,
		install:tomcat:start
		" />

	<target name="install:tomcat:binaries" description="Install tomcat binaries" unless="exclude.tomcat">
		<delete dir="${application.base.path}"/>
		<unzip dest="${application.base.path}" src="${tools.dir.src}/${tomcat.binaries.file}" />
		<if>
			<os family="unix"/>
			<then>
				<chmod dir="${tomcat.home}/bin" perm="ugo+rx" 
					includes="**/*.sh"/>
			</then>
		</if>
	</target>

	<target name="install:tomcat:configure" description="Configure tomcat (change ports)" unless="exclude.tomcat">
		<!-- Change ports -->
		<xmlconfig in="${tomcat.home}/conf/server.xml" verbose="false">
			<update path="(//Connector)[@port=8080]/@port" value="${tomcat.port.http}" />
			<update path="(//Connector)[@redirectPort=8443]/@redirectPort" value="${tomcat.port.ssl}" />
			<update path="(//Connector)[@port=8009]/@port" value="${tomcat.port.ajp}" />
			<update path="(//Connector)[@port=8443]/@port" value="${tomcat.port.ssl}" />
			<update path="(//Server)[@port=8005]/@port" value="${tomcat.port.shutdown}" />
		</xmlconfig>
	</target>

	<target name="install:tomcat:start" description="Start Tomcat" unless="exclude.tomcat">
		<if>
			<not>
				<isset property="exclude.start.servers"/>
			</not>
			<then>
				<echo message="******************** ${tomcat.home} **************">
				</echo>
				<tomcat-start tomcat.home="${tomcat.home}"/>
			</then>
		</if>
	</target>

	<!-- Wrapper target to deploy all containers to one server -->
	<target name="install" description="Installs and configures JBOSS,Tomcat creates database, and deploys application" 
		depends="
		install:validation:pre-install,
		install:jboss:stop,
		install:tomcat:stop,
		install:validation:jboss:pre-install:ports,
		install:validation:tomcat:pre-install:ports,
		install:clean,
		install:init,
		install:database,
		install:jboss,
		install:tomcat,
		install:tomcat:start,
		install:jboss:start,
		install:validation:jboss:post-install,
		install:validation:tomcat:post-install
		"/>

	<!-- Fixes hibernate dialect and other configurations in code generated at build time.  This is requred because the properties/options selected at build time can be different than those used at install time. -->
	<target name="install:jboss:upt:re-configure" unless="exclude.jboss">
		<!-- 
		<delete dir="${working.dir}/generic-webapp"/>
		<unzip src="${generic-webapp.dir.dist}/${generic-webapp.war.file}" dest="${working.dir}/generic-webapp"/>
		<copy todir="${working.dir}/generic-webapp/WEB-INF/classes" file="${jboss-conf.dir.dest}/hibernate.cfg.xml"/>

		<move file="${generic-webapp.dir.dist}/${generic-webapp.war.file}" tofile="${generic-webapp.dir.dist}/${generic-webapp.war.file}.orig"/>
		<war destfile="${generic-webapp.dir.dist}/${generic-webapp.war.file}" compress="false" webxml="${working.dir}/generic-webapp/WEB-INF/web.xml" >
			<fileset dir="${working.dir}/generic-webapp">
				<include name="*/**" />
			</fileset>
		</war>  
		-->
	</target>

	<!-- Fixes hibernate dialect and other configurations in code generated at build time.  This is requred because the properties/options selected at build time can be different than those used at install time. -->
	<target name="install:tomcat:upt:re-configure" unless="exclude.tomcat">
		<!-- 
		<delete dir="${working.dir}/generic-webapp"/>
		<unzip src="${generic-webapp.dir.dist}/${generic-webapp.war.file}" dest="${working.dir}/generic-webapp"/>
		<copy todir="${working.dir}/generic-webapp/WEB-INF/classes" file="${jboss-conf.dir.dest}/hibernate.cfg.xml"/>

		<move file="${generic-webapp.dir.dist}/${generic-webapp.war.file}" tofile="${generic-webapp.dir.dist}/${generic-webapp.war.file}.orig"/>
		<war destfile="${generic-webapp.dir.dist}/${generic-webapp.war.file}" compress="false" webxml="${working.dir}/generic-webapp/WEB-INF/web.xml" >
			<fileset dir="${working.dir}/generic-webapp">
				<include name="*/**" />
			</fileset>
		</war>  
		-->
	</target>

	<!-- Wrapper target to upgrade jboss container. Does not install or configure binaries -->
	<target name="upgrade:jboss" unless="exclude.jboss"
		depends="
		install:validation:pre-install,
		install:jboss:stop,
		install:init,
		install:jboss:upt:re-configure,
		install:jboss:upt,
		install:jboss:upt:configure,
		install:jboss:start
		" />
		
		<!-- Wrapper target to upgrade tomcat container. Does not install or configure binaries -->
	<target name="upgrade:tomcat" description="Wrapper target to call all targets required to upgrade tomcat container." unless="exclude.tomcat"
		depends="
		install:validation:pre-install,
		install:tomcat:stop,
		install:init,
		install:tomcat:upt,
		install:tomcat:upt:configure,
		install:tomcat:start
		" />
		


	<!-- Wrapper target to upgrade all container. Does not install or configure binaries -->
	<target name="upgrade" description="Deploys application and runs incremental database build" 
		depends="
		upgrade:init,
		install:validation:pre-install,
		install:jboss:stop,
		install:tomcat:stop,
		install:init,
		upgrade:database,
		upgrade:jboss,
		upgrade:tomcat,
		install:validation:jboss:post-install,
		install:validation:tomcat:post-install
		"/>

	<!-- Wrapper upgrade database target, depends on both MySQL and Oracle sub-targets, ifs should ensure only one is run.  Target path can be skipped by exlude.database. -->
	<target name="upgrade:database" description="Apply incremental DB changes" unless="exclude.database"
		depends="
		install:init,
		upgrade:init
		">
		<!-- **figure out the changes/scripts based upon current version IN the database, if any ** -->
		<switch value="${database.type}">
			<case value="oracle">
				<if>
					<available file="${db-incr.list.file}"/>
					<then>
						<property name="db.continue" value="true"/>
						<database-create-control-table
							database.url="${database.url}"
							database.user="${database.user}"
							database.password="${database.password}"
							/>
						<database-identify-scripts
							sqlfiles.list.file="${db-incr.list.file}"
							build.properties.file="${db-incr.conf.file}"
							sql.delimiter="/" 
							sql.delimitertype="row"
							database.sql.dir="${db-upgrade.dir.dest}"/>
					</then>
					<else>
						<echo message="Could not find an incremental file list file ${db-incr.list.file}, there must not be any incrmental updates."/>
					</else>
				</if>
			</case>
			<case value="mysql">
				<if>
					<available file="${db-incr.list.file}"/>
					<then>
						<property name="db.continue" value="true"/>
						<database-create-control-table
							database.url="${database.url}"
							database.user="${database.user}"
							database.password="${database.password}"
							/>
						<database-identify-scripts
							sqlfiles.list.file="${db-incr.list.file}"
							build.properties.file="${db-incr.conf.file}"
							database.sql.dir="${db-upgrade.dir.dest}"
							/>
					</then>
					<else>
						<echo message="Could not find an incremental file list file ${db-incr.list.file}, there must not be any incrmental updates."/>
					</else>
				</if>
			</case>
			<case value="postgresql">
				<if>
					<available file="${db-incr.list.file}"/>
					<then>
						<property name="db.continue" value="true"/>
						<database-create-control-table
							database.url="${database.url}"
							database.user="${database.user}"
							database.password="${database.password}"
							/>
						<database-identify-scripts
							sqlfiles.list.file="${db-incr.list.file}"
							build.properties.file="${db-incr.conf.file}"
							sql.delimiter="/" 
							sql.delimitertype="row"
							database.sql.dir="${db-upgrade.dir.dest}"/>
					</then>
					<else>
						<echo message="Could not find an incremental file list file ${db-incr.list.file}, there must not be any incrmental updates."/>
					</else>
				</if>
			</case>
		</switch>
		<echo  message="db.continue=${db.continue}"/>
		<if>
			<isset property="db.continue"/>
			<then>
				<!-- **make the changes to the db aka invoke the proper scripts ** -->
				<antcall target="database-integrate" />
				<!-- ** make sure the versioning information IN the database is updated to reflect what we just did ** -->
				<database-update-version-table
					database.driver="${database.driver}"
					database.url="${database.url}"
					database.user="${database.user}"
					database.password="${database.password}"/>
			</then>
		</if>
	</target>

	<target name="upgrade:init">
		<if>
			<equals arg1="${exclude.tomcat}" arg2="true" />
			<then>
				<echo
					message="Checking if database properties exist.  If they do not on an upgrade install then ${jboss.home}/server/${jboss.server.name}/deploy/${upt.ds.file} may not exist." />
				<property name="db.prop.list" value="database.url,database.user,database.password,database.name" />
				<properties-exist properties.list="${db.prop.list}" />
			</then>
			<else>
				<echo message="upgrade:init target needs to be updated for tomcat" />
			</else>
		</if>
	</target>
</project>
