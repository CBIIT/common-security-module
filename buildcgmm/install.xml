<?xml version="1.0" encoding="utf-8" ?>
<!-- bda-build-template version 1.0.1 -->
<!--
$Id: install.xml 1593 2009-04-27 21:29:25Z saksass $
$HeadURL: https://gforge.nci.nih.gov/svnroot/automation/trunk/software/bda-build-template/software/build/install.xml $
-->

<project name="cgmmweb" default="install" basedir="." xmlns:ivy="antlib:org.apache.ivy.ant">

	<import file="bda-master-install.xml" />

	<property name="cgmmweb.dir.dist" value="${basedir}/${cgmmweb.dist.relative.dir}" />
	<property name="cgmm.war.file" value="cgmmweb.war" />

	<property name="cgmm-webapp.name" value="cgmmweb" />

	<target name="install" description="Wrapper scripts that calls all required targets to install the jboss container" unless="exclude.jboss" depends="
		-set:jboss:cgmmweb:application:url,
		common:jboss:init,
		common:init,
		install:jboss:init,
		install:jboss:validation:pre-install,
		install:jboss:stop,
		install:jboss:validation:pre-install:ports,
		install:jboss:clean,
		install:jboss:binaries,
		install:jboss:cgmm-webapp,
		install:jboss:cgmm-webapp:configure,
		install:jboss:configure,
		install:jboss:configure:cgmm:log4j,
		install:jboss:configure:cgmm:mail-service,
		install:post:jboss,
		install:jboss:start,
		install:jboss:validation:post-install
		">
	</target>

	<target name="upgrade" description="Upgrades JBoss and Database" depends="		
		-set:jboss:cgmmweb:application:url,
		upgrade:jboss:init,
		common:init,
		common:jboss:init,
		install:common:validation:pre-install,
		install:jboss:validation:pre-install,
		install:jboss:stop,
		install:jboss:cgmm-webapp,
		install:jboss:cgmm-webapp:configure,
		install:jboss:configure,
		install:jboss:configure:cgmm:log4j,
		install:jboss:configure:cgmm:mail-service,
		install:post:jboss,
		install:jboss:start,
		install:jboss:validation:post-install
		">
	</target>

	<target name="install:jboss:cgmm-webapp" description="Deploy bda-blueprints-webapp and common libraries to jboss installation" unless="exclude.jboss" depends="common:init">
		<delete dir="${jboss.home}/server/${jboss.server.name}/tmp" />
		<delete dir="${jboss.home}/server/${jboss.server.name}/work" />
		<move file="${jboss.home}/server/${jboss.server.name}/log/server.log" tofile="${jboss.home}/server/${jboss.server.name}/log/server/log.${install.time}" failonerror="false" />

		<copy file="${cgmmweb.dir.dist}/${cgmm.war.file}" todir="${jboss.home}/server/${jboss.server.name}/deploy" overwrite="true" />
		<!--  Many NCI applications require clm for csm, so you can point this to where you have the version you want to use
		<copy file="${bda-utils.dir}/clm-3.2.jar" todir="${jboss.home}/server/${jboss.server.name}/lib" overwrite="true" />
		-->
		<copy file="${database.driver.file}" todir="${jboss.home}/server/${jboss.server.name}/lib" overwrite="true" />
	</target>

	<target name="-set:jboss:cgmmweb:application:url">
		<property name="jboss.application.url" value="http://${jboss.server.hostname}:${jboss.server.port}/${cgmm-webapp.name}"/>
	</target>

	<!-- configure target grid -->
	<target name="install:jboss:configure:target_grid">
		<!-- configure target grid -->
		<switch value="${target_grid}">
			<case value="training-1.2">
				<property name="SERVICE_NAME" value="caGrid Training" />
				<property name="CAGRID_AUTHENTICATION_SERVICE_URL" value="https://dorian.training.cagrid.org:8443/wsrf/services/cagrid/Dorian" />
				<property name="CAGRID_DORIAN_SERVICE_URL" value="${CAGRID_AUTHENTICATION_SERVICE_URL}" />
			</case>
			<case value="nci_dev-1.2">
				<property name="SERVICE_NAME" value="caGrid Dev" />
				<property name="CAGRID_AUTHENTICATION_SERVICE_URL" value="https://cbiovdev5035.nci.nih.gov:8443/wsrf/services/cagrid/Dorian" />
				<property name="CAGRID_DORIAN_SERVICE_URL" value="${CAGRID_AUTHENTICATION_SERVICE_URL}" />
			</case>
			<case value="nci_qa-1.2">
				<property name="SERVICE_NAME" value="caGrid QA" />
				<property name="CAGRID_AUTHENTICATION_SERVICE_URL" value="https://cagrid-dorian-qa.nci.nih.gov:8443/wsrf/services/cagrid/Dorian" />
				<property name="CAGRID_DORIAN_SERVICE_URL" value="${CAGRID_AUTHENTICATION_SERVICE_URL}" />
			</case>
			<case value="nci_stage-1.2">
				<property name="SERVICE_NAME" value="caGrid Staging 1.2" />
				<property name="CAGRID_AUTHENTICATION_SERVICE_URL" value="https://cagrid-dorian-stage.nci.nih.gov:8443/wsrf/services/cagrid/Dorian" />
				<property name="CAGRID_DORIAN_SERVICE_URL" value="${CAGRID_AUTHENTICATION_SERVICE_URL}" />
			</case>
			<case value="nci_prod-1.2">
				<property name="SERVICE_NAME" value="caGrid Prod 1.2" />
				<property name="CAGRID_AUTHENTICATION_SERVICE_URL" value="https://cagrid-dorian.nci.nih.gov:8443/wsrf/services/cagrid/Dorian" />
				<property name="CAGRID_DORIAN_SERVICE_URL" value="${CAGRID_AUTHENTICATION_SERVICE_URL}" />
			</case>
			<default>
				<echo message="target grid ${target_grid}." />
				<property name="SERVICE_NAME" value="${authentication-service-name}" />
				<property name="CAGRID_AUTHENTICATION_SERVICE_URL" value="${authentication-service-url}" />
				<property name="CAGRID_DORIAN_SERVICE_URL" value="${dorian-service-url}" />
			</default>
		</switch>

		<copy todir="${user.home}/.globus/certificates" overwrite="true">
			<fileset dir="${target_grid.dist.relative.dir}/${target_grid}/gts-rootcertificates">
			</fileset>
		</copy>
		<copy todir="${jboss.home}/server/default/cgmm_config" file="${target_grid.dist.relative.dir}/${target_grid}/sync-description.xml" overwrite="true"/>
		<copy todir="${jboss.home}/server/default/cgmm_config" overwrite="true">
			<fileset dir="${cgmmweb.dist.relative.dir}">
				<include name="*cgmm-properties.xml"/>
				<include name="*cgmm-properties.xsd"/>
			</fileset>
			<filterset refid="embedded.filterset"/>
			<filterset>
				<filtersfile file="${properties.file}"/>
				<filtersfile file="project.properties"/>
			</filterset>
			<filterset>
				<filter token="SERVICE_NAME" value="${SERVICE_NAME}"/>
				<filter token="CAGRID_AUTHENTICATION_SERVICE_URL" value="${CAGRID_AUTHENTICATION_SERVICE_URL}"/>
				<filter token="CAGRID_DORIAN_SERVICE_URL" value="${CAGRID_DORIAN_SERVICE_URL}"/>
			</filterset>
		</copy>
	</target>

	<target name="install:jboss:configure:cgmm:mail-service" description="Configure custom entries in mail-service.xml" unless="exclude.jboss" depends="common:jboss:init, common:init">
		<echo message="Configuring mailservice" />
		<property name="mail-service.file.name" value="mail-service.xml" />
		<copy file="${jboss.home}/server/${jboss.server.name}/deploy/${mail-service.file.name}" tofile="${jboss.home}/server/${jboss.server.name}/deploy/${mail-service.file.name}.pre" />

		<xmltask source="${jboss.home}/server/${jboss.server.name}/deploy/${mail-service.file.name}" dest="${jboss.home}/server/${jboss.server.name}/deploy/${mail-service.file.name}">
			<xmlcatalog refid="bda.xml.catalog" />
			<remove path="/server/mbean[@name='jboss:service=Mail']" />
			<insert path="/server" position="under">
				<![CDATA[
					<mbean code="org.jboss.mail.MailService" name="jboss:service=Mail">
				<attribute name="JNDIName">${mail.jndi.name}</attribute>
				<attribute name="User">${mail.service.user}</attribute>
				<attribute name="Password">${mail.service.password}</attribute>
				<attribute name="Configuration">
					<configuration>
						<property name="mail.transport.protocol" value="smtp"/>
						<property name="mail.smtp.host" value="${mail.smtp.server}"/>
						<!--        <property name="mail.smtp.port" value="465"/>-->
						<property name="mail.smtp.auth" value="${mail.smtp.auth}"/>
						<property name="mail.smtp.starttls.enable" value="${mail.smtp.starttls.enable}"/>
						<property name="mail.debug" value="${mail.debug}"/>
					</configuration>
				</attribute>
			</mbean>
				]]>
			</insert>
		</xmltask>
	</target>

	<target name="install:jboss:configure:log4j" description="Configure custom entries in system wide log4j" unless="exclude.jboss" depends="">
		<echo message="abstract install:jboss:configure:log4j target called" />
	</target>

	<target name="install:jboss:configure:cgmm:log4j" description="Configure custom entries in system wide log4j" unless="exclude.jboss" depends="common:jboss:init, common:init">
		<echo message="Configuring Log4J" />
		<property name="log4j.file.name" value="log4j.xml" />
		<copy file="${jboss.home}/server/${jboss.server.name}/conf/${log4j.file.name}" tofile="${jboss.home}/server/${jboss.server.name}/conf/${log4j.file.name}.pre" />
	
		<replaceregexp file="${jboss.home}/server/${jboss.server.name}/conf/${log4j.file.name}" byline="true" match="^(&lt;!DOCTYPE.*)" replace="&lt;!\-\-\1\-\-&gt;" />
		<if>
			<equals arg1="${enable.common.logging.module}" arg2="true" casesensitive="false" />
			<then>
				<switch value="${clm.database.type}">
					<case value="oracle">
						<property name="clm.database.driver.file" value="${bda-utils.dir}/ojdbc14-10.2.0.4.0.jar" />
						<property name="clm.database.driver" value="oracle.jdbc.driver.OracleDriver" />
					</case>
					<case value="mysql">
						<property name="clm.database.driver.file" value="${bda-utils.dir}/mysql-connector-java-5.0.8.jar" />
						<property name="clm.database.driver" value="com.mysql.jdbc.Driver" />
					</case>
					<case value="postgresql">
						<property name="clm.database.driver.file" value="${bda-utils.dir}/postgresql-jdbc3-8.3-604.jar" />
						<property name="clm.database.driver" value="org.postgresql.Driver" />
					</case>
					<default>
						<fail message="Invalid database type ${clm.database.type}" />
					</default>
				</switch>
				<copy file="${database.driver.file}" todir="${jboss.home}/server/${jboss.server.name}/lib" overwrite="true" />
				<xmltask source="${jboss.home}/server/${jboss.server.name}/conf/${log4j.file.name}" dest="${jboss.home}/server/${jboss.server.name}/conf/${log4j.file.name}">
					<xmlcatalog refid="bda.xml.catalog" />
					<remove path="/log4j:configuration/appender[@name='CLM_APPENDER']" />
					<insert path="/log4j:configuration/appender[last()]" position="after">
						<![CDATA[
					<appender name="CLM_APPENDER" class="gov.nih.nci.logging.api.appender.jdbc.JDBCAppender">
						<param name="application" value="${APPLICATION_NAME}" />
						<param name="maxBufferSize" value="1" />
						<param name="dbDriverClass" value="${clm.database.driver}" />
						<param name="dbUrl" value="${clm.database.url}" />
						<param name="dbUser" value="${clm.database.user}" />
						<param name="dbPwd" value="${clm.database.password}" />
						<param name="useFilter" value="true" />
	
						<layout class="org.apache.log4j.PatternLayout">
							<param name="ConversionPattern" value=":: [%d{ISO8601}] %-5p %c{1}.%M() %x - %m%n" />
						</layout>
					</appender>
					]]>
		         </insert>
			</xmltask>
			<xmltask source="${jboss.home}/server/${jboss.server.name}/conf/${log4j.file.name}" dest="${jboss.home}/server/${jboss.server.name}/conf/${log4j.file.name}">
				<xmlcatalog refid="bda.xml.catalog" />
				<remove path="/log4j:configuration/category[@name='CGMM.Audit.Logging']" />
				<insert path="/log4j:configuration/root" position="before">
					<![CDATA[
					<category name="CGMM.Audit.Logging">
					<level value="info" />
					<appender-ref ref="CLM_APPENDER" />
				</category>
					]]>
				</insert>
			</xmltask>
		</then>
		</if>
		<xmltask source="${jboss.home}/server/${jboss.server.name}/conf/${log4j.file.name}" dest="${jboss.home}/server/${jboss.server.name}/conf/${log4j.file.name}">
		<xmlcatalog refid="bda.xml.catalog" />
		<remove path="/log4j:configuration/category[@name='COM.claymoresystems.ptls.SSLDebug']" />
		<insert path="/log4j:configuration/root" position="before">
			<![CDATA[
					<category name="COM.claymoresystems.ptls.SSLDebug">
			<priority value="OFF" />
		</category>
					]]>
				</insert>
		</xmltask>
		<!--<validate-log4j log4j.file="${jboss.home}/server/${jboss.server.name}/conf/${log4j.file.name}" />-->
		<replaceregexp file="${jboss.home}/server/${jboss.server.name}/conf/${log4j.file.name}" byline="true" match="^&lt;!\-\-(&lt;!DOCTYPE.*)\-\-&gt;" replace="\1" />
	</target>


	<target name="install:jboss:cgmm-webapp:configure" depends="install:jboss:configure:target_grid,install:jboss:jbossweb-tomcat55:configure">
		<copy todir="${jboss.home}/server/default/cgmm_config" overwrite="true">
			<fileset dir="${cgmmweb.dist.relative.dir}">
				<include name="*ApplicationSecurityConfig.xml"/>
				<include name="*cgmm.login.config"/>
				<include name="*cgmmweb.hibernate.cfg.xml"/>
			</fileset>
			<filterset refid="embedded.filterset"/>
			<filterset>
			<filtersfile file="${properties.file}"/>
			<filtersfile file="project.properties"/>
			</filterset>
		</copy>
	
	<!-- This code is for updating properties.service.xml, make sure to add ${line.separator} after each property def as the property delimiter, if this is not included you will not get the desired results. If you do not use properties service.xml you can delete this code. -->
		<var name="property.block" value="gov.nih.nci.security.cgmm.syncgts.file=${jboss.home}/server/default/cgmm_config/sync-description.xml${line.separator}
					gov.nih.nci.security.cgmm.properties.file=${jboss.home}/server/default/cgmm_config/cgmm-properties.xml${line.separator}
					gov.nih.nci.security.configFile=${jboss.home}/server/default/cgmm_config/ApplicationSecurityConfig.xml${line.separator}
					gov.nih.nci.security.cgmm.login.config.file=${jboss.home}/server/default/cgmm_config/cgmm.login.config${line.separator}
					"/>
		<copy file="${jboss.home}/server/${jboss.server.name}/deploy/properties-service.xml" tofile="${jboss.home}/server/${jboss.server.name}/deploy/properties-service.xml.orig" overwrite="true" />
		<jboss-update-properties-service property.block="${property.block}" />
	</target>

	<target name="install:jboss:jbossweb-tomcat55:configure">
		<copy todir="${jboss.home}/server/default/lib" overwrite="true">
			<fileset dir="${cgmmweb.dir.dist}/jboss-default-lib-jars">
			</fileset>
		</copy>
		<copy todir="${jboss.home}/server/default/deploy/jbossweb-tomcat55.sar" overwrite="true">
			<fileset dir="${cgmmweb.dir.dist}/jbossweb-tomcat55-sar-jars">
			</fileset>
		</copy>
		<copy tofile="${jboss.home}/server/default/deploy/jbossweb-tomcat55.sar/cgmmapi.jar" file="${cgmmweb.dir.dist}/jars/jbossweb-tomcat55-sar-cgmmapi.jar" overwrite="true">
		</copy>
		<copy todir="${jboss.home}/server/default/lib" file="${cgmmweb.dir.dist}/clm-4.1.jar" overwrite="true">
		</copy>
	</target>
</project>
